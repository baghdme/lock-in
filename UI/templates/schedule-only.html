{% extends "base.html" %}

{% block title %}Your Optimized Schedule{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}" />
<style>
  .container-schedule {
    margin: 0 auto;
    max-width: 1500px;
    padding: 20px;
  }
  .schedule-content {
    display: flex;
    justify-content: center;
    text-align: left;
  }
  .schedule-wrapper {
    flex: 1;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border-radius: 12px;
    max-width: 1200px;
  }
  .header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .schedule-actions {
    display: flex;
    gap: 10px;
  }
  .btn {
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: none;
    transition: background-color 0.2s;
  }
  .btn-primary {
    background-color: #4285f4;
    color: white;
  }
  .btn-primary:hover {
    background-color: #3367d6;
  }
  .btn-secondary {
    background-color: #f1f3f4;
    color: #202124;
  }
  .btn-secondary:hover {
    background-color: #e8eaed;
  }
  .reset-button {
    background-color: #ea4335;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 16px;
    cursor: pointer;
  }
  .reset-button:hover {
    background-color: #d33426;
  }
  .loading {
    text-align: center;
    padding: 30px;
    font-size: 18px;
    color: #4285f4;
    background-color: rgba(66, 133, 244, 0.1);
    border-radius: 8px;
    margin: 20px 0;
  }
  .loading::after {
    content: "";
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 3px solid #4285f4;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
    margin-left: 10px;
    vertical-align: middle;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .error-message {
    text-align: center;
    padding: 20px;
    color: #ea4335;
    background-color: rgba(234, 67, 53, 0.1);
    border-radius: 8px;
    margin: 20px 0;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-schedule">
  <!-- Updated header section with improved design for schedule-only.html -->
  <div class="header-container">
    <h1>My Weekly Schedule</h1>
    <div class="schedule-actions">
      <a href="{{ url_for('preferences') }}" class="btn btn-secondary">Change Preferences</a>
      <button onclick="regenerateSchedule()" class="btn btn-primary">Regenerate Schedule</button>
      <button onclick="exportToGoogleCalendar()" class="btn btn-primary" style="background-color: #0F9D58;">Export to Google Calendar</button>
      <button onclick="resetScheduleUI()" class="reset-button">Reset Schedule</button>
    </div>
  </div>
  <div class="schedule-content">
    <div id="scheduleContainer" class="schedule-wrapper">
      <div id="scheduleOutput"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- force reload of updated main.js -->
<script src="{{ url_for('static', filename='js/main.js') }}?v=2"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    fetch('/get-schedule')
      .then(response => response.json())
      .then(data => {
        if (data.schedule && (data.schedule.generated_calendar || data.schedule.meetings || data.schedule.tasks)) {
          localStorage.setItem('currentSchedule', JSON.stringify(data.schedule));
          processSchedule(data.schedule);
        } else {
          localStorage.removeItem('currentSchedule');
          window.location.href = '/';
        }
      })
      .catch(err => {
        console.error('Error fetching schedule from server:', err);
        window.location.href = '/';
      });
  });

  function processSchedule(raw) {
    console.log('🔍 raw schedule-only JSON:', raw);
    // Use raw.schedule if present and if it has a generated_calendar; otherwise, use raw directly
    const sched = (raw && raw.schedule && raw.schedule.generated_calendar) ? raw.schedule : raw;
    // If no valid schedule object (neither a generated_calendar nor meetings/tasks), redirect
    if (!sched || (!sched.generated_calendar && !sched.meetings && !sched.tasks)) {
      console.warn('No valid schedule found. Redirecting to schedule generation page.');
      window.location.href = '/';
      return;
    }
    console.log('✅ using schedule object for calendar:', sched);
    // If a generated_calendar exists, display the formatted calendar; otherwise, use the simple schedule view
    if (sched.generated_calendar) {
      displayFormattedSchedule(sched);
    } else {
      displaySimpleSchedule({ schedule: sched });
    }
    
    // Fallback: if nothing is rendered in scheduleOutput after 3 seconds, show an error message
    setTimeout(() => {
      const outputEl = document.getElementById('scheduleOutput');
      if (!outputEl.innerHTML.trim()) {
        console.error('No content rendered in scheduleOutput after processing schedule.');
        outputEl.innerHTML = '<div class="error-message">No schedule content loaded. Please generate a new schedule.</div>';
      }
    }, 3000);
  }
</script>

<script>
  function regenerateSchedule() {
    // Show loading state
    const scheduleOutput = document.getElementById('scheduleOutput');
    scheduleOutput.innerHTML = '<div class="loading">Regenerating your schedule based on your preferences...</div>';
    
    // Call the regenerate endpoint
    fetch('/regenerate-schedule', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || 'Failed to regenerate schedule');
        });
      }
      return response.json();
    })
    .then(data => {
      // Update the UI with the new schedule
      localStorage.setItem('currentSchedule', JSON.stringify(data));
      processSchedule(data);
    })
    .catch(error => {
      console.error('Error regenerating schedule:', error);
      scheduleOutput.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
    });
  }

  function exportToGoogleCalendar() {
    // Show loading state
    const scheduleOutput = document.getElementById('scheduleOutput');
    const originalContent = scheduleOutput.innerHTML;
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading';
    loadingDiv.textContent = 'Exporting your schedule to Google Calendar...';
    scheduleOutput.prepend(loadingDiv);
    
    // First, we need to authorize with Google if not already authorized
    fetch('/google-calendar/export-to-google', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      // Remove loading state
      if (loadingDiv.parentNode) {
        loadingDiv.parentNode.removeChild(loadingDiv);
      }
      
      if (!response.ok) {
        return response.json().then(data => {
          if (response.status === 401 && data.needs_auth) {
            // Authorization required - redirect to Google OAuth flow
            console.log('Google Calendar authorization required. Redirecting to authorization page...');
            window.location.href = '/google-calendar/authorize';
            // Throw a special error to halt further processing
            throw new Error('AUTH_REDIRECT');
          }
          throw new Error(data.error || 'Failed to export schedule to Google Calendar');
        });
      }
      return response.json();
    })
    .then(data => {
      // Alert the user about the successful export
      if (data.created > 0) {
        alert(`Successfully exported ${data.created} events to your Google Calendar!`);
      } else {
        alert('No new events were added to your Google Calendar.');
      }
    })
    .catch(error => {
      console.error('Error exporting to Google Calendar:', error);
      
      // Skip the rest of the error handling if we're redirecting for auth
      if (error.message === 'AUTH_REDIRECT') {
        return;
      }
      
      // Alert the user about the error
      alert(`Error exporting to Google Calendar: ${error.message}`);
    });
  }
</script>
{% endblock %}
