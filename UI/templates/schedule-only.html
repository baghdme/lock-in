{% extends "base.html" %}

{% block title %}Your Optimized Schedule{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}" />
<style>
  .container-schedule {
    margin: 0 auto;
    max-width: 1500px;
    padding: 20px;
  }
  .schedule-content {
    display: flex;
    gap: 25px;
    justify-content: flex-start;
    text-align: left;
  }
  .schedule-wrapper {
    flex: 4;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border-radius: 12px;
  }
  .chat-wrapper {
    flex: 1;
    min-width: 320px;
    max-width: 400px;
  }
  .header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .schedule-actions {
    display: flex;
    gap: 10px;
  }
  .btn {
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: none;
    transition: background-color 0.2s;
  }
  .btn-primary {
    background-color: #4285f4;
    color: white;
  }
  .btn-primary:hover {
    background-color: #3367d6;
  }
  .btn-secondary {
    background-color: #f1f3f4;
    color: #202124;
  }
  .btn-secondary:hover {
    background-color: #e8eaed;
  }
  .reset-button {
    background-color: #ea4335;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 16px;
    cursor: pointer;
  }
  .reset-button:hover {
    background-color: #d33426;
  }
  .loading {
    text-align: center;
    padding: 30px;
    font-size: 18px;
    color: #4285f4;
    background-color: rgba(66, 133, 244, 0.1);
    border-radius: 8px;
    margin: 20px 0;
  }
  .loading::after {
    content: "";
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 3px solid #4285f4;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
    margin-left: 10px;
    vertical-align: middle;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .error-message {
    text-align: center;
    padding: 20px;
    color: #ea4335;
    background-color: rgba(234, 67, 53, 0.1);
    border-radius: 8px;
    margin: 20px 0;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-schedule">
  <!-- Updated header section with improved design for schedule-only.html -->
  <div class="header-container">
    <h1>My Weekly Schedule</h1>
    <div class="schedule-actions">
      <a href="{{ url_for('preferences') }}" class="btn btn-secondary">Change Preferences</a>
      <button onclick="regenerateSchedule()" class="btn btn-primary">Regenerate Schedule</button>
      <button onclick="resetScheduleUI()" class="reset-button">Reset Schedule</button>
    </div>
  </div>
  <div class="schedule-content">
    <div id="scheduleContainer" class="schedule-wrapper">
      <div id="scheduleOutput"></div>
    </div>
    <div class="chat-wrapper">
      <div id="chat-container">
        <div class="chat-header">Schedule Assistant</div>
        <div id="chat-log">
          <!-- Chat messages will appear here -->
        </div>
        <div id="chat-form-container">
          <div style="position: relative; width: 100%;">
            <form id="chat-form" onsubmit="sendChatMessage(); return false;">
              <div class="input-with-buttons">
                <button type="button" class="circular-button upload-button" aria-label="Upload file" style="background-color: #ff6b6b !important; border-radius: 50% !important; display: flex !important; align-items: center !important; justify-content: center !important; width: 36px !important; height: 36px !important; min-width: 36px !important; min-height: 36px !important; padding: 0 !important; border: none !important; margin: 2px !important; color: white !important;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="stroke: white !important;">
                    <path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <input type="text" id="user-input" placeholder="Ask about your schedule..." />
                <button type="submit" class="circular-button send-button" aria-label="Send message" style="background-color: #ff6b6b !important; border-radius: 50% !important; display: flex !important; align-items: center !important; justify-content: center !important; width: 36px !important; height: 36px !important; min-width: 36px !important; min-height: 36px !important; padding: 0 !important; border: none !important; margin: 2px !important; color: white !important;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="stroke: white !important;">
                    <path d="M5 12h14M13 5l7 7-7 7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- force reload of updated main.js -->
<script src="{{ url_for('static', filename='js/main.js') }}?v=2"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    fetch('/get-schedule')
      .then(response => response.json())
      .then(data => {
        if (data.schedule && (data.schedule.generated_calendar || data.schedule.meetings || data.schedule.tasks)) {
          localStorage.setItem('currentSchedule', JSON.stringify(data.schedule));
          processSchedule(data.schedule);
        } else {
          localStorage.removeItem('currentSchedule');
          window.location.href = '/';
        }
      })
      .catch(err => {
        console.error('Error fetching schedule from server:', err);
        window.location.href = '/';
      });
  });

  function processSchedule(raw) {
    console.log('🔍 raw schedule-only JSON:', raw);
    // Use raw.schedule if present and if it has a generated_calendar; otherwise, use raw directly
    const sched = (raw && raw.schedule && raw.schedule.generated_calendar) ? raw.schedule : raw;
    // If no valid schedule object (neither a generated_calendar nor meetings/tasks), redirect
    if (!sched || (!sched.generated_calendar && !sched.meetings && !sched.tasks)) {
      console.warn('No valid schedule found. Redirecting to schedule generation page.');
      window.location.href = '/';
      return;
    }
    console.log('✅ using schedule object for calendar:', sched);
    // If a generated_calendar exists, display the formatted calendar; otherwise, use the simple schedule view
    if (sched.generated_calendar) {
      displayFormattedSchedule(sched);
    } else {
      displaySimpleSchedule({ schedule: sched });
    }
    
    // Fallback: if nothing is rendered in scheduleOutput after 3 seconds, show an error message
    setTimeout(() => {
      const outputEl = document.getElementById('scheduleOutput');
      if (!outputEl.innerHTML.trim()) {
        console.error('No content rendered in scheduleOutput after processing schedule.');
        outputEl.innerHTML = '<div class="error-message">No schedule content loaded. Please generate a new schedule.</div>';
      }
    }, 3000);
    
    // Add initial welcome message
    const chatLog = document.getElementById('chat-log');
    const assistantContainer = document.createElement('div');
    assistantContainer.className = 'message-container assistant-container';
    const assistantMessage = document.createElement('div');
    assistantMessage.className = 'message assistant';
    assistantMessage.textContent = "Welcome! I can help you understand your schedule. You can ask me things like 'What meetings do I have on Monday?' or 'When is my next exam?'";
    assistantContainer.appendChild(assistantMessage);
    chatLog.appendChild(assistantContainer);
    
    // Add click handler for upload button
    const uploadButton = document.querySelector('.upload-button');
    if (uploadButton) {
      uploadButton.addEventListener('click', () => {
        alert('File upload feature would appear here!');
      });
    }
  }
</script>

<script>
  function sendChatMessage() {
    const input = document.getElementById('user-input');
    const message = input.value.trim();
    if (message === '') return;
    
    const chatLog = document.getElementById('chat-log');
    
    // Add user message
    const userContainer = document.createElement('div');
    userContainer.className = 'message-container user-container';
    
    const userMessage = document.createElement('div');
    userMessage.className = 'message user';
    userMessage.textContent = message;
    
    userContainer.appendChild(userMessage);
    chatLog.appendChild(userContainer);
    
    // Clear input
    input.value = '';
    
    // Simulate assistant response (in a real app, this would come from an API)
    setTimeout(() => {
      // Add assistant message
      const assistantContainer = document.createElement('div');
      assistantContainer.className = 'message-container assistant-container';
      
      const assistantMessage = document.createElement('div');
      assistantMessage.className = 'message assistant';
      
      // Customize responses based on common schedule questions
      if (message.toLowerCase().includes('monday')) {
        assistantMessage.textContent = "Looking at your Monday schedule, I can see you have several items scheduled. Is there something specific about Monday you'd like to know?";
      } else if (message.toLowerCase().includes('exam')) {
        assistantMessage.textContent = "I can see you have an exam coming up. Would you like to know more about your exam preparation schedule?";
      } else if (message.toLowerCase().includes('busy') || message.toLowerCase().includes('free time')) {
        assistantMessage.textContent = "Based on your schedule, your busiest days appear to be in the middle of the week. You have more free time on weekends.";
      } else {
        assistantMessage.textContent = "I can help you understand your schedule better. You can ask about specific days, events, or even when you might have free time.";
      }
      
      assistantContainer.appendChild(assistantMessage);
      chatLog.appendChild(assistantContainer);
      
      // Scroll to bottom
      chatLog.scrollTop = chatLog.scrollHeight;
    }, 1000);
    
    // Scroll to bottom after user message
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function regenerateSchedule() {
    // Show loading state
    const scheduleOutput = document.getElementById('scheduleOutput');
    scheduleOutput.innerHTML = '<div class="loading">Regenerating your schedule based on your preferences...</div>';
    
    // Call the regenerate endpoint
    fetch('/regenerate-schedule', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || 'Failed to regenerate schedule');
        });
      }
      return response.json();
    })
    .then(data => {
      // Update the UI with the new schedule
      localStorage.setItem('currentSchedule', JSON.stringify(data));
      processSchedule(data);
      
      // Add message to chat log about successful regeneration
      const chatLog = document.getElementById('chat-log');
      const assistantContainer = document.createElement('div');
      assistantContainer.className = 'message-container assistant-container';
      const assistantMessage = document.createElement('div');
      assistantMessage.className = 'message assistant';
      assistantMessage.textContent = "I've regenerated your schedule based on your current preferences!";
      assistantContainer.appendChild(assistantMessage);
      chatLog.appendChild(assistantContainer);
      chatLog.scrollTop = chatLog.scrollHeight;
    })
    .catch(error => {
      console.error('Error regenerating schedule:', error);
      scheduleOutput.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      
      // Add error message to chat log
      const chatLog = document.getElementById('chat-log');
      const assistantContainer = document.createElement('div');
      assistantContainer.className = 'message-container assistant-container';
      const assistantMessage = document.createElement('div');
      assistantMessage.className = 'message assistant';
      assistantMessage.textContent = `I couldn't regenerate your schedule: ${error.message}. Please try again later.`;
      assistantContainer.appendChild(assistantMessage);
      chatLog.appendChild(assistantContainer);
      chatLog.scrollTop = chatLog.scrollHeight;
    });
  }
</script>
{% endblock %}
